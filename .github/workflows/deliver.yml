name: deliver

on:
  push:
    branches: [ "main" ]

permissions:
    id-token: write
    contents: read
  
jobs:
  pull_request:
    runs-on: ubuntu-latest
    
    steps:
      - name: Download artifact
        id: download-artifact
        uses: dawidd6/action-download-artifact@v2 #GH still doesn't have an official script to share data between workflows, using community version.
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          workflow: provision.yml
          workflow_conclusion: success
          path: ./
          name: output

      - name: Parse artifact data
        run: | 
          echo "ROLE_ARN=$(grep -m 1 'gh_role_arn' output.txt | cut -d "=" -f 2 | cut -b 2- | tr -d ")" >> $GITHUB_ENV
          echo "REGION=$(grep -m 1 'id' output.txt | cut -d "=" -f 2 | cut -b 2-) | tr -d ")" >> $GITHUB_ENV
          echo "BUCKET_URL=$(grep -m 1 'bucket_url' output.txt | cut -d "=" -f 2 | cut -b 2- | tr -d ")" >> $GITHUB_ENV
          rm output.txt
          
      - name: configureawscredentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
         role-to-assume: $ROLE_ARN
         role-session-name: delivery
         role-duration-seconds: 900
         aws-region: $REGION

      - name: checkout
        uses: actions/checkout@v3
        
      - name: s3upload
        run: | 
          aws s3 cp --recursive ./static $BUCKET_URL
